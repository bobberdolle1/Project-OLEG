# Архитектура бота "Олег" (Версия 3.0)

## Обзор

Версия 3.0 представляет собой полностью переработанную архитектуру бота "Олег", превращающую его из простого модератора в автономного ИИ-участника сообщества. В основе архитектуры - принципы Plug & Play, контекстного обучения и адаптивного поведения.

## Компоненты системы

### 1. Ядро бота
- **aiogram 3.x** - фреймворк для взаимодействия с Telegram API
- **SQLAlchemy async** - асинхронный ORM для работы с базой данных
- **Ollama** - локальный движок для ИИ-моделей
- **ChromaDB** - векторная база данных для RAG (Retrieval Augmented Generation)

### 2. Модули ИИ
- **Мультимодальная модель** (qwen2-vl:2b-instruct-q5_1) - обработка текста и изображений
- **Система RAG** - контекстное обучение и память
- **Адаптивный промпт-инжиниринг** - динамическая настройка поведения

### 3. Системы модерации
- **Режимы модерации** - "Лайт", "Норма", "Диктатура"
- **Автообнаружение контекста** - анализ описания чата, правил, закрепленных сообщений
- **Система "Я не бот"** - подтверждение новых участников
- **Фильтр токсичности** - мониторинг и реагирование на токсичные сообщения

### 4. Адаптивные функции
- **Рандомные ответы** - бот сам вставляет реплики в чат
- **Индивидуальный стиль общения** - адаптация под поведение пользователя
- **Токсичность-зависимое поведение** - стиль меняется в зависимости от общего тона чата

### 5. Управление через Telegram
- **Админ-панель в ЛС** - полное управление ботом через личные сообщения
- **Команды администрирования** - добавление/удаление админов, баны, настройки
- **Интеграция с базой данных** - хранение настроек для каждого чата

## Структура проекта

```
app/
├── __init__.py                 # Информация о версии
├── main.py                     # Главный файл запуска
├── config.py                   # Конфигурация приложения
├── database/                   # Модели и сессии БД
│   ├── __init__.py
│   ├── models.py              # Модели SQLAlchemy
│   └── session.py             # Управление сессиями
├── handlers/                   # Обработчики команд и сообщений
│   ├── __init__.py
│   ├── qna.py                 # Обработка вопросов
│   ├── games.py               # Игровые функции
│   ├── moderation.py          # Модерация
│   ├── admin_commands.py      # Команды администратора
│   ├── chat_join.py           # Обработчики событий добавления
│   └── ...                    # Другие обработчики
├── services/                   # Внешние сервисы
│   ├── __init__.py
│   ├── ollama_client.py       # Клиент Ollama
│   ├── toxicity_analyzer.py   # Анализ токсичности
│   └── ...                    # Другие сервисы
├── middleware/                 # Промежуточные обработчики
│   ├── __init__.py
│   ├── logging.py             # Логирование
│   ├── spam_filter.py         # Фильтр спама
│   ├── mode_filter.py         # Фильтр режимов модерации
│   └── ...                    # Другие middleware
└── utils/                      # Вспомогательные функции
    ├── __init__.py
    └── helpers.py             # Вспомогательные утилиты
```

## Ключевые особенности архитектуры

### Автоматическая настройка (Plug & Play)
- Бот автоматически определяет тип чата при добавлении
- Сканирует контекст (описание, закрепленные сообщения) и генерирует индивидуальный промпт
- Приветствует новых участников и проверяет, являются ли они ботами

### Контекстное обучение (RAG)
- Использует ChromaDB для хранения знаний о чате и пользователях
- Автоматически извлекает и сохраняет факты из сообщений
- При генерации ответов использует релевантные знания из базы

### Адаптивное поведение
- Уровень токсичности в ответах зависит от общей атмосферы в чате
- В личных сообщениях стиль адаптируется под поведение конкретного пользователя
- Рандомные ответы активируются с учетом активности в чате

### Безопасность
- Защита от промпт-инъекций
- Черный список пользователей (локальный и глобальный)
- Фильтр спама и токсичных сообщений
- Система подтверждения "Я не бот"

### Управление через Telegram
- Полноценная админ-панель доступна через ЛС
- Все настройки хранятся в базе данных
- Интерактивные меню с inline-кнопками

## Технологии

- **Python 3.10+** - основной язык программирования
- **aiogram 3.x** - асинхронный фреймворк для Telegram
- **SQLAlchemy 2.x** - ORM для работы с базой данных
- **Ollama** - локальный движок ИИ
- **qwen2-vl** - мультимодальная модель
- **ChromaDB** - векторная база данных
- **Alembic** - миграции базы данных
- **APScheduler** - планировщик задач
- **Flask** - веб-админка (опционально)

## Запуск

### Docker (рекомендуется)
```bash
cp .env.docker .env
# Настроить .env
docker-compose up -d
```

### Локально
```bash
pip install -r requirements.txt
# Настроить .env
python -m app.main
```

## Лицензия

Проект лицензирован под MIT License - см. файл LICENSE для подробностей.