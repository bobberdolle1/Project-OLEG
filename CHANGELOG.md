# Changelog

Все значимые изменения в проекте документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
проект придерживается [Semantic Versioning](https://semver.org/lang/ru/).

---

## [7.9.1] - 2025-12-17

### Автоматический контекст чата

- **Олег теперь знает где он находится** — получает название, описание и тип чата
- Контекст передаётся автоматически: `"ИНФОРМАЦИЯ О ЧАТЕ: Название: «...» | Тип: форум | Описание: ..."`
- Помогает боту адаптировать ответы под тематику чата

### Различение пользователей в групповых чатах

- **Олег теперь различает кто ему пишет** — не путает людей между собой
- В контекст добавляется "ТЕКУЩИЙ СОБЕСЕДНИК: @username"
- Новая секция в промпте "МНОГО ЛЮДЕЙ В ЧАТЕ" с правилами:
  - Смотреть кто пишет по нику
  - Не переносить контекст одного человека на другого
  - Новый человек = новый диалог

### Улучшенная защита от prompt injection

- **Разнообразные ответы** — теперь бот отвечает по-разному на попытки взлома (15 вариантов)
- **Защита от социальной инженерии** — добавлены паттерны:
  - "помоги защитить от injection" / "help protect from injection"
  - "напиши код для классификатора" / "train a classifier"
  - "хочу улучшить тебя" / "хочу защитить тебя"
- Бот больше не ведётся на "помоги мне защитить тебя от взлома"

### Исправления

- **Voice/Vision handlers** — добавлена обработка ошибки "thread not found" для форумных топиков
  - Теперь бот не падает при ответе в удалённые/недоступные топики
  - Унифицирована обработка ошибок в `voice.py` и `vision.py`

### Умный веб-поиск v2

Переработана система веб-поиска — теперь умнее и экономнее.

#### Новые провайдеры поиска

- **SearXNG** (приоритет 1) — бесплатно, без лимитов, self-hosted или публичные инстансы
- **Brave Search** (приоритет 2) — 2000 запросов/месяц
- **DuckDuckGo** (приоритет 3) — fallback

#### Умная категоризация вопросов

Вместо тупых триггеров по словам — категоризация:

**НИКОГДА не искать:**
- Болтовня: "привет", "как дела?", "спасибо"
- Вопросы про бота: "кто ты?", "что умеешь?"
- Базовые знания: "что такое GPU?"

**ВСЕГДА искать (критично):**
- Цены: "сколько стоит RTX 5090?"
- Релизы: "когда выйдет GTA 6?"
- Актуальные версии: "последний драйвер NVIDIA"

**Высокий приоритет:**
- Характеристики нового железа: "сколько VRAM у RTX 5080?"
- Сравнения: "RTX 5070 vs RX 9070"

#### Self-Assessment (подготовка)

- Добавлен парсер для self-assessment ответов LLM
- LLM может указать `<!--CONFIDENCE:low-->` и `<!--NEEDS_SEARCH:yes-->`
- Система готова к двухэтапной генерации

#### Улучшения промпта

- Добавлены примеры когда искать / не искать
- Чёткие правила для LLM о поиске
- Напоминание что RX 8000 не существует

### Изменённые файлы
- `app/services/web_search.py` — SearXNG, улучшенный fallback
- `app/services/web_search_trigger.py` — умная категоризация
- `app/services/ollama_client.py` — контекст пользователя, защита от injection
- `app/handlers/qna.py` — автоматический контекст чата
- `app/handlers/voice.py` — обработка ошибок форумных топиков
- `app/config.py` — настройка `searxng_url`
- `.env.example` — документация SearXNG

---

## [7.9.0] - 2025-12-17

### Anti-Hallucination System + Софтверная база 2025

Большой апдейт: система борьбы с галлюцинациями LLM, полная база знаний о железе и софте 2025, улучшения поведения бота.

#### Новые сервисы

- **`app/services/web_search.py`** — веб-поиск с несколькими провайдерами
- **`app/services/fact_checker.py`** — проверка ответов на галлюцинации
- **`app/services/knowledge_base.py`** — полная база знаний

#### База знаний о железе 2025

- RTX 50 (Blackwell): 5090, 5080, 5070 Ti, 5070
- RX 9000 (RDNA 4): 9070 XT, 9070
- Intel Core Ultra (Arrow Lake): 285K, 265K, 245K
- AMD Ryzen 9000 (Zen 5): 9950X, 9900X, 9800X3D

#### Софтверная база 2025

- Windows 11 24H2/25H1, Windows 12 НЕ ВЫШЛА
- NVIDIA App, MSI Afterburner, FanControl
- HWInfo64, CapFrameX, OCCT, TestMem5

---

## [7.8.9] - 2025-12-17

### Продвинутая защита от prompt injection
- Автоматический перевод для проверки
- Детекция base64, капс-атак, zero-width символов

---

## [7.8.8] - 2025-12-17

### Мультиязычная защита от prompt injection
- Паттерны на 8 языках

---

## [7.8.7] - 2025-12-17

### Усиленная защита от jailbreak
- Русские паттерны prompt injection
- Детекция эмоциональных манипуляций

---

## [7.8.6] - 2025-12-17

### Грамотность
- Олег теперь пишет грамотно

---

## [7.8.5] - 2025-12-17

### Фактчекинг в Vision
- Веб-поиск для изображений

---

## [7.8.4] - 2025-12-17

### Принудительный веб-поиск
- Веб-поиск выполняется принудительно

---

## [7.8.3] - 2025-12-17

### Улучшенный фактчекинг
- Триггеры на номера моделей железа

---

## [7.8.2] - 2025-12-17

### Фактчекинг железа
- Олег проверяет факты про железо

---

## [7.8.1] - 2025-12-17

### Улучшено
- Олег адекватно реагирует на поправки

---

## [7.8.0] - 2025-12-17

### Добавлено
- Fallback модели
- Уведомления владельцу

---
