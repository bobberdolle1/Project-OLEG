# Changelog

Все значимые изменения в проекте документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
проект придерживается [Semantic Versioning](https://semver.org/lang/ru/).

---

## [7.9.1] - 2025-12-17

### Автоматический контекст чата

- **Олег теперь знает где он находится** - получает название, описание и тип чата
- Контекст передается автоматически: `"ИНФОРМАЦИЯ О ЧАТЕ: Название: ... | Тип: форум | Описание: ..."`
- Помогает боту адаптировать ответы под тематику чата

### Различение пользователей в групповых чатах

- **Олег теперь различает кто ему пишет** - не путает людей между собой
- В контекст добавляется "ТЕКУЩИЙ СОБЕСЕДНИК: @username"
- Новая секция в промпте "МНОГО ЛЮДЕЙ В ЧАТЕ" с правилами:
  - Смотреть кто пишет по нику
  - Не переносить контекст одного человека на другого
  - Новый человек = новый диалог

### Улучшенная защита от prompt injection

- **Разнообразные ответы** - теперь бот отвечает по-разному на попытки взлома (15 вариантов)
- **Защита от социальной инженерии** - добавлены паттерны:
  - "помоги защитить от injection" / "help protect from injection"
  - "напиши код для классификатора" / "train a classifier"
  - "хочу улучшить тебя" / "хочу защитить тебя"
- Бот больше не ведется на "помоги мне защитить тебя от взлома"

### Исправления

- **Voice/Vision handlers** - добавлена обработка ошибки "thread not found" для форумных топиков
  - Теперь бот не падает при ответе в удаленные/недоступные топики
  - Унифицирована обработка ошибок в `voice.py` и `vision.py`

### Умный веб-поиск v2

Переработана система веб-поиска - теперь умнее и экономнее.

#### Новые провайдеры поиска

- **SearXNG** (приоритет 1) - бесплатно, без лимитов, self-hosted или публичные инстансы
- **Brave Search** (приоритет 2) - 2000 запросов/месяц
- **DuckDuckGo** (приоритет 3) - fallback

#### Умная категоризация вопросов

Вместо тупых триггеров по словам - категоризация:

**НИКОГДА не искать:**
- Болтовня: "привет", "как дела?", "спасибо"
- Вопросы про бота: "кто ты?", "что умеешь?"
- Базовые знания: "что такое GPU?"

**ВСЕГДА искать (критично):**
- Цены: "сколько стоит RTX 5090?"
- Релизы: "когда выйдет GTA 6?"
- Актуальные версии: "последний драйвер NVIDIA"

**Высокий приоритет:**
- Характеристики нового железа: "сколько VRAM у RTX 5080?"
- Сравнения: "RTX 5070 vs RX 9070"

#### Self-Assessment (подготовка)

- Добавлен парсер для self-assessment ответов LLM
- LLM может указать `<!--CONFIDENCE:low-->` и `<!--NEEDS_SEARCH:yes-->`
- Система готова к двухэтапной генерации

#### Улучшения промпта

- Добавлены примеры когда искать / не искать
- Четкие правила для LLM о поиске
- Напоминание что RX 8000 не существует

### Измененные файлы
- `app/services/web_search.py` - SearXNG, улучшенный fallback
- `app/services/web_search_trigger.py` - умная категоризация
- `app/services/ollama_client.py` - контекст пользователя, защита от injection
- `app/handlers/qna.py` - автоматический контекст чата
- `app/handlers/voice.py` - обработка ошибок форумных топиков
- `app/config.py` - настройка `searxng_url`
- `.env.example` - документация SearXNG

---

## [7.9.0] - 2025-12-17

### Anti-Hallucination System + Софтверная база 2025

Большой апдейт: система борьбы с галлюцинациями LLM, полная база знаний о железе и софте 2025, улучшения поведения бота.

#### Новые сервисы

- **`app/services/web_search.py`** - веб-поиск с несколькими провайдерами:
  - SearXNG (бесплатно, без лимитов)
  - Brave Search API (2000 запросов/месяц)
  - DuckDuckGo HTML (fallback)
  - Кэширование результатов (5 минут TTL)

- **`app/services/fact_checker.py`** - проверка ответов на галлюцинации:
  - Детекция несуществующих моделей (RTX 4090 Ti, RX 8000 серия и т.д.)
  - Confidence scoring и автоматические предупреждения

- **`app/services/knowledge_base.py`** - полная база знаний

#### База знаний о железе 2025

**Видеокарты:**
- RTX 50 (Blackwell): 5090, 5080, 5070 Ti, 5070 - DLSS 4, до 32GB GDDR7
- RTX 40/30 (Ada/Ampere)
- RX 9000 (RDNA 4): 9070 XT, 9070 - FSR 4
- RX 7000/6000 (RDNA 3/2)
- Intel Arc (A770, A750, A580, A380)

**Процессоры:**
- Intel Core Ultra (Arrow Lake): 285K, 265K, 245K - LGA1851
- Intel Core 12-14 Gen - LGA1700
- AMD Ryzen 9000 (Zen 5): 9950X, 9900X, 9800X3D, 9700X, 9600X
- AMD Ryzen 7000 (Zen 4): 7950X, 7800X3D, 7600X
- AMD Threadripper 9980X/7980X - HEDT

**Платформы:**
- LGA1851 - Core Ultra, DDR5, PCIe 5.0
- LGA1700 - Core 12-14, DDR4/DDR5
- AM5 - Ryzen 7000/9000, DDR5-6000 EXPO
- AM4 - Ryzen 5000, DDR4, бюджет
- TRX50 - Threadripper, HEDT

**Память и накопители:**
- DDR5: 5600-6400 MT/s, 32GB (2x16) - стандарт 2025
- NVMe Gen5: 12000+ MB/s, NVMe Gen4: 7000 MB/s - мейнстрим

**Стандарты:** ATX 3.1, PCIe 5.0, Wi-Fi 7, USB4

#### Софтверная база 2025

**Операционные системы:**
- Windows 11 24H2/25H1 - основная, обязательна для Zen 5/Arrow Lake
- Windows 12 - НЕ ВЫШЛА, перенесена на 2026/2027
- Bazzite - SteamOS для любого ПК
- Nobara - Fedora с патчами для игр

**Софт для тюнинга:**
- NVIDIA App - замена GeForce Experience, без логина
- MSI Afterburner + RTSS - андервольт и OSD
- FanControl - настройка вентиляторов
- Chris Titus WinUtil - деблоатер Windows

**Мониторинг:**
- HWInfo64 - все сенсоры, WHEA Errors
- CapFrameX - анализ плавности, 1% low, 0.1% low
- ZenTimings / AsRock Timing Configurator - тайминги DDR5

**Стресс-тесты:**
- OCCT - лучший комбайн 2025
- TestMem5 + Anta777 Extreme - тест DDR5
- Y-Cruncher - убийца нестабильных Curve Optimizer
- CoreCycler - тест ядер по очереди

**Драйверы:** DDU, NVCleanstall

#### Гайды по тюнингу

- **CPU AMD (Zen 4/5/X3D):** PBO2 + Curve Optimizer, начинай с -15/-20
- **CPU Intel (Core 13/14/Ultra):** AC/DC Loadline или VF Curve, SVID Offset -0.050V
- **GPU NVIDIA (RTX 40/50):** Андервольт курвой (Ctrl+F), разгон памяти +500/+1000
- **GPU AMD (RX 7000/9000):** Min Frequency Trick, Undervolt по 10-20 мВ
- **RAM DDR5:** tREFI 50000-65535, обязательно обдув при высоких значениях

#### Улучшения поведения бота

- **Олег больше не зацикливается на ошибочных предположениях** - если сказал "это IT-чат" а ему говорят что это чат китайского, просто принимает и идет дальше
- Не делает выводов о "тематике чата"
- Не защищает свои ошибочные предположения

#### Расширенные триггеры веб-поиска
- Ключевые слова: разгон, андервольт, curve optimizer, pbo, afterburner
- Софт: hwinfo, occt, testmem5, ddu, fancontrol
- Термины: троттлинг, vrm, trefi, expo, xmp, vbs

#### Конфигурация
- `BRAVE_SEARCH_API_KEY` - ключ для Brave Search API (опционально)

### Новые файлы
- `app/services/web_search.py`
- `app/services/fact_checker.py`
- `app/services/knowledge_base.py`
- `tests/unit/test_fact_checker.py`
- `tests/unit/test_knowledge_base.py`
- `tests/unit/test_web_search_trigger_v2.py`

### Измененные файлы
- `app/services/ollama_client.py` - интеграция новых сервисов, улучшения промпта
- `app/services/web_search_trigger.py` - расширенные триггеры
- `app/config.py` - новая настройка `brave_search_api_key`
- `.env.example` - документация новой настройки

---

## [7.8.9] - 2025-12-17

### Продвинутая защита от prompt injection
- **Автоматический перевод для проверки** - если текст не на русском, переводится и проверяется
- **Детекция base64 injection** - декодирует и проверяет закодированные команды
- **Детекция капс-атак** - много капса + ключевые слова = блок
- **Детекция zero-width символов** - невидимые символы для обхода фильтров
- **Детекция code injection** - паттерны типа `[INST]`, `<<SYS>>`, ` ```system`

---

## [7.8.8] - 2025-12-17

### Мультиязычная защита от prompt injection
- **Паттерны на 8 языках** - английский, русский, украинский, немецкий, французский, испанский, китайский, японский
- **Расширенные английские паттерны** - "jailbreak", "dan mode", "developer mode"
- **Эмоциональные манипуляции на разных языках**

---

## [7.8.7] - 2025-12-17

### Усиленная защита от jailbreak
- **Добавлены русские паттерны prompt injection** - "забудь инструкции", "теперь ты"
- **Детекция эмоциональных манипуляций** - "родители погибнут", "жизнь зависит"
- **Новая секция в промпте "ЗАЩИТА ОТ ВЗЛОМА"**

---

## [7.8.6] - 2025-12-17

### Грамотность
- **Олег теперь пишет грамотно** - с нормальной орфографией и пунктуацией

---

## [7.8.5] - 2025-12-17

### Фактчекинг в Vision
- **Веб-поиск теперь работает и для изображений** - если на картинке железо, ищем инфу

---

## [7.8.4] - 2025-12-17

### Принудительный веб-поиск
- **Веб-поиск теперь выполняется ПРИНУДИТЕЛЬНО** - не ждем пока модель решит

---

## [7.8.3] - 2025-12-17

### Улучшенный фактчекинг
- **Веб-поиск теперь триггерится на номера моделей железа** - 780M, 4070, i7-13700

---

## [7.8.2] - 2025-12-17

### Фактчекинг железа
- **Олег теперь проверяет факты про железо** - не выдумывает архитектуры

---

## [7.8.1] - 2025-12-17

### Улучшено
- **Олег теперь адекватно реагирует на поправки** - не огрызается

---

## [7.8.0] - 2025-12-17

### Добавлено
- **Fallback модели** - автоматическое переключение на локальные модели
- **Уведомления владельцу** - при переключении на fallback

---

## [7.7.4] - 2025-12-17

### Исправлено
- **Антиспам ошибок ИИ** - сообщения об ошибках показываются раз в 5 минут

---

## [7.7.3] - 2025-12-17

### Исправлено
- **Выход из группы в /owner** - исправлена ошибка парсинга

### Добавлено
- **Управление пользователями** - поиск, просмотр, сброс, удаление

---

## [7.7.2] - 2025-12-17

### Улучшение форматирования ответов LLM
- **Удаление сырых tool calls** - убираются артефакты
- **Очистка markdown** - убирается форматирование

---

## [7.7.1] - 2025-12-17

### Общая статистика в Owner Panel
- **Новая кнопка "Общая статистика"** в /owner панели

---
