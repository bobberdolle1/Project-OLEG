"""–ú–æ–¥—É–ª—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (Vision Module) –¥–ª—è –±–æ—Ç–∞ –û–ª–µ–≥."""

import logging
import base64
import asyncio
from io import BytesIO
from typing import Optional
import httpx
from aiogram import Router, F
from aiogram.types import Message
from aiogram.filters import Command

from app.config import settings
from app.services.ollama_client import _ollama_chat

logger = logging.getLogger(__name__)

router = Router()

def _detect_loop_in_text(text: str, min_pattern_len: int = 20, max_repeats: int = 3) -> tuple[bool, str]:
    """
    –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ –≤ —Ç–µ–∫—Å—Ç–µ (–ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω—ã).
    
    Args:
        text: –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        min_pattern_len: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
        max_repeats: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π –¥–æ –æ–±—Ä–µ–∑–∫–∏
        
    Returns:
        (is_looped, cleaned_text) - —Ñ–ª–∞–≥ –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è –∏ –æ—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    """
    if len(text) < min_pattern_len * 2:
        return False, text
    
    # –ò—â–µ–º –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ä–∞–∑–Ω–æ–π –¥–ª–∏–Ω—ã
    for pattern_len in range(min_pattern_len, min(200, len(text) // 3)):
        for start in range(len(text) - pattern_len * 2):
            pattern = text[start:start + pattern_len]
            
            # –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–∞—Ç—Ç–µ—Ä–Ω –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –ø–æ–¥—Ä—è–¥
            count = 1
            pos = start + pattern_len
            while pos + pattern_len <= len(text) and text[pos:pos + pattern_len] == pattern:
                count += 1
                pos += pattern_len
            
            # –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ
            if count >= max_repeats:
                # –û–±—Ä–µ–∑–∞–µ–º –¥–æ –ø–µ—Ä–≤–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è + –Ω–µ–º–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                cleaned = text[:start + pattern_len]
                logger.warning(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ: –ø–∞—Ç—Ç–µ—Ä–Ω '{pattern[:50]}...' –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è {count} —Ä–∞–∑")
                return True, cleaned
    
    return False, text


async def analyze_image_with_vlm(image_data: bytes, prompt: str) -> str:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏ Ollama.

    Args:
        image_data: –ë–∞–π—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        prompt: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ –º–æ–¥–µ–ª–∏

    Returns:
        –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    """
    try:
        # –ö–æ–¥–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64 –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ API
        image_base64 = base64.b64encode(image_data).decode('utf-8')

        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π
        system_prompt = """–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. 
–°–¢–†–û–ì–ò–ï –ü–†–ê–í–ò–õ–ê:
- –û–ø–∏—Å—ã–≤–∞–π –¢–û–õ–¨–ö–û —Ç–æ, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –≤–∏–¥–∏—à—å
- –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π –¥–∏–∞–ª–æ–≥–∏, –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, –∏—Å—Ç–æ—Ä–∏–∏
- –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π —Ñ—Ä–∞–∑—ã
- –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É
- –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω ‚Äî —Å–∫–∞–∂–∏ "–Ω–µ –º–æ–≥—É –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å"
"""

        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫ Ollama
        payload = {
            "model": settings.ollama_vision_model,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥–µ–ª—å –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
            "messages": [
                {
                    "role": "system",
                    "content": system_prompt
                },
                {
                    "role": "user",
                    "content": prompt,
                    "images": [image_base64]  # –ü–µ—Ä–µ–¥–∞–µ–º –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                }
            ],
            "stream": False,
            "options": {
                "temperature": 0.1,  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
                "num_ctx": 2048,
                "num_predict": 256,  # –ö–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã
                "repeat_penalty": 2.0,  # –ñ—ë—Å—Ç–∫–∏–π —à—Ç—Ä–∞—Ñ –∑–∞ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
                "top_p": 0.9,
                "top_k": 40
            }
        }

        async with httpx.AsyncClient(timeout=settings.ollama_timeout) as client:
            response = await client.post(
                f"{settings.ollama_base_url}/api/chat",
                json=payload
            )
            response.raise_for_status()

            data = response.json()
            result = data.get("message", {}).get("content", "").strip()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ –∏ –æ—á–∏—â–∞–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            is_looped, cleaned_result = _detect_loop_in_text(result)
            if is_looped:
                cleaned_result += "\n\n[–û–ª–µ–≥ –∑–∞–≤–∏—Å, –Ω–æ —è –µ–≥–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–ª]"
                return cleaned_result
            
            return result

    except httpx.ConnectError:
        logger.error("–ù–µ –º–æ–≥—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Ollama —Å–µ—Ä–≤–µ—Ä—É")
        return "‚ùå –ù–µ –º–æ–≥—É —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ò–ò. –ü—Ä–æ–≤–µ—Ä—å, –∑–∞–ø—É—â–µ–Ω –ª–∏ Ollama —Å –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª—å—é."
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
        return "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ."


async def extract_image_bytes(message: Message) -> Optional[bytes]:
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –±–∞–π—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è.

    Args:
        message: –°–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º

    Returns:
        –ë–∞–π—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ None
    """
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ —Ñ–æ—Ç–æ –∏–∑ —Å–ø–∏—Å–∫–∞
        if message.photo:
            # –ë–µ—Ä–µ–º —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤ —Å–ø–∏—Å–∫–µ)
            photo = message.photo[-1]

            # –ü–æ–ª—É—á–∞–µ–º file_info –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
            file_info = await message.bot.get_file(photo.file_id)

            # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            file_bytes_io = await message.bot.download_file(file_info.file_path)
            image_bytes = file_bytes_io.read()
            return image_bytes
        elif message.document and message.document.mime_type and message.document.mime_type.startswith('image/'):
            # –ï—Å–ª–∏ —ç—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            file_info = await message.bot.get_file(message.document.file_id)
            file_bytes_io = await message.bot.download_file(file_info.file_path)
            image_bytes = file_bytes_io.read()
            return image_bytes
        else:
            return None
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
        return None


@router.message(F.photo | F.document)
async def handle_image_message(msg: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏.
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–µ–∫—Å—Ç —Ä—è–¥–æ–º —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º (–¥–ª—è –∑–∞–ø—Ä–æ—Å–∞)
    text = msg.caption if msg.caption else ""

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –∫–æ–º–∞–Ω–¥–æ–π
    if text and text.startswith('/'):
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    image_bytes = await extract_image_bytes(msg)
    if not image_bytes:
        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è {msg.message_id}")
        return

    # –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ –∑–∞–ø—Ä–æ—Å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    if text and text.strip():
        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –≤–æ–ø—Ä–æ—Å–æ–º
        vision_prompt = f"""–¢—ã ‚Äî —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä—Ç. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–í–û–ü–†–û–°: {text}

–ü–†–ê–í–ò–õ–ê:
1. –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–æ–≥–æ, —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –≤–∏–¥–∏—à—å –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
2. –ï—Å–ª–∏ —ç—Ç–æ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å –æ—à–∏–±–∫–æ–π ‚Äî —É–∫–∞–∂–∏ –æ—à–∏–±–∫—É –∏ –∫–∞–∫ –µ—ë –∏—Å–ø—Ä–∞–≤–∏—Ç—å
3. –ï—Å–ª–∏ —ç—Ç–æ –∫–æ–¥ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –µ–≥–æ
4. –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ (–º–µ–º, —Ñ–æ—Ç–æ, –∏–≥—Ä–∞) ‚Äî –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ —á—Ç–æ –≤–∏–¥–∏—à—å
5. –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ –¥–∏–∞–ª–æ–≥–∏
6. –û—Ç–≤–µ—Ç –º–∞–∫—Å–∏–º—É–º 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
7. –ì–æ–≤–æ—Ä–∏ –ø–æ –¥–µ–ª—É, –±–µ–∑ –≤–æ–¥—ã"""
    else:
        # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç–∞ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –æ–ø–∏—Å—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        vision_prompt = """–¢—ã ‚Äî —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä—Ç. –û–ø–∏—à–∏ —á—Ç–æ –≤–∏–¥–∏—à—å –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏.

–ü–†–ê–í–ò–õ–ê:
1. –ï—Å–ª–∏ —ç—Ç–æ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å –æ—à–∏–±–∫–æ–π –∏–ª–∏ –∫–æ–¥–æ–º ‚Äî —É–∫–∞–∂–∏ —á—Ç–æ –∑–∞ –æ—à–∏–±–∫–∞/–∫–æ–¥ –∏ –∫–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å
2. –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ (–º–µ–º, —Ñ–æ—Ç–æ, –∏–≥—Ä–∞, –∞—Ä—Ç) ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–∏ "–≠—Ç–æ [—á—Ç–æ —ç—Ç–æ]. –í–æ–ø—Ä–æ—Å–æ–≤ –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–µ –Ω–µ—Ç?"
3. –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π –∏—Å—Ç–æ—Ä–∏–∏, –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ –¥–∏–∞–ª–æ–≥–∏
4. –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ
5. –û—Ç–≤–µ—Ç –º–∞–∫—Å–∏–º—É–º 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
6. –ï—Å–ª–∏ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—à—å —á—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ ‚Äî —Ç–∞–∫ –∏ —Å–∫–∞–∂–∏"""

    from aiogram.exceptions import TelegramBadRequest

    processing_msg = None
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞
        processing_msg = await msg.reply("üëÄ –†–∞–∑–≥–ª—è–¥—ã–≤–∞—é...")

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        analysis_result = await analyze_image_with_vlm(image_bytes, vision_prompt)

        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
        if processing_msg:
            try:
                await processing_msg.delete()
            except:
                pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏

        # –û–±—Ä–µ–∑–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (–ª–∏–º–∏—Ç Telegram - 4096 —Å–∏–º–≤–æ–ª–æ–≤)
        max_length = 4000  # –û—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∞—Å
        if len(analysis_result) > max_length:
            analysis_result = analysis_result[:max_length] + "...\n\n[–æ–±—Ä–µ–∑–∞–Ω–æ, —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞]"

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        await msg.reply(analysis_result)

    except TelegramBadRequest as e:
        # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Ç–∏–ø–∞ "thread not found" - —Ç–æ–ø–∏–∫ –±—ã–ª —É–¥–∞–ª—ë–Ω
        if "thread not found" in str(e).lower() or "message to reply not found" in str(e).lower():
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–≤–µ—Ç–∏—Ç—å - —Ç–æ–ø–∏–∫/—Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ: {e}")
        else:
            logger.error(f"Telegram –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
        try:
            await msg.reply("–ì–ª–∞–∑–∞ –º–æ–∏ —Ä–∞–∑–ª—é–±–∏–ª–∏. –ù–µ –º–æ–≥—É —Ä–∞–∑–≥–ª—è–¥–µ—Ç—å, —á—Ç–æ —Ç–∞–º –Ω–∞ —Å–∫—Ä–∏–Ω–µ.")
        except:
            pass  # –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º –æ—Ç–≤–µ—Ç–∏—Ç—å - –ø—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º


# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –º–æ–¥—É–ª—è –∑—Ä–µ–Ω–∏—è
@router.message(Command("vision_test"))
async def cmd_vision_test(msg: Message):
    """
    –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–¥—É–ª—è –∑—Ä–µ–Ω–∏—è.
    """
    await msg.reply(
        "üì∏ –ú–æ–¥—É–ª—å –∑—Ä–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!\n"
        "–ü—Ä–∏—à–ª–∏ —Ñ–æ—Ç–æ —Å–æ —Å–≤–æ–∏–º –≤–æ–ø—Ä–æ—Å–æ–º –≤ –æ–ø–∏—Å–∞–Ω–∏–∏, –∏ —è –≤—Å—ë —Ä–∞—Å—Å–º–æ—Ç—Ä—é –∏ –æ—Ç–≤–µ—á—É –ø–æ —Å—É—â–µ—Å—Ç–≤—É."
    )