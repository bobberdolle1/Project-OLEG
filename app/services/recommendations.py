"""–°–∏—Å—Ç–µ–º–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""

import random
import time
from collections import defaultdict
from sqlalchemy.ext.asyncio import AsyncSession
from app.database.models import User

# –ö—É–ª–¥–∞—É–Ω —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
RECOMMENDATION_COOLDOWN = 300  # 5 –º–∏–Ω—É—Ç
# –®–∞–Ω—Å –ø–æ–∫–∞–∑–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
RECOMMENDATION_CHANCE = 0.12  # 12%

# –¢—Ä–µ–∫–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
_last_recommendation_time: dict[int, float] = defaultdict(float)
_last_recommendation_type: dict[int, str] = {}


# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
RECOMMENDATIONS = {
    # === –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´ ===
    "grow": [
        "üí° /grow ‚Äî –∫–∞—á–∞–π —Ä–∞–∑–º–µ—Ä —Ä–∞–∑ –≤ 12 —á–∞—Å–æ–≤",
        "üí° –ù–µ –∑–∞–±—ã–≤–∞–π –ø—Ä–æ /grow –∫–∞–∂–¥—ã–π –¥–µ–Ω—å",
        "üí° –†–∞–∑–º–µ—Ä —Ä–µ—à–∞–µ—Ç! –ñ–º–∏ /grow",
    ],
    "pvp": [
        "üí° /challenge @–Ω–∏–∫ ‚Äî –≤—ã–∑–æ–≤–∏ –Ω–∞ –¥—É—ç–ª—å",
        "üí° –û—Ç–≤–µ—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ + /challenge = –±–æ–π",
        "üí° PvP —Å –û–ª–µ–≥–æ–º: –ø—Ä–æ—Å—Ç–æ /challenge",
    ],
    "top": [
        "üí° /top ‚Äî —Ç–æ–ø –ø–æ —Ä–∞–∑–º–µ—Ä—É",
        "üí° /top_rep ‚Äî —Ç–æ–ø –ø–æ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏",
        "üí° /top_elo ‚Äî —Ç–æ–ø –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É PvP",
    ],
    
    # === –ò–ì–†–´ ===
    "casino": [
        "üí° /casino 100 ‚Äî —Å–ª–æ—Ç—ã, –¥–∂–µ–∫–ø–æ—Ç x5",
        "üí° /bj 100 ‚Äî –±–ª—ç–∫–¥–∂–µ–∫ –ø—Ä–æ—Ç–∏–≤ –¥–∏–ª–µ—Ä–∞",
        "üí° /coinflip 100 –æ—Ä—ë–ª ‚Äî –ø–æ–¥–±—Ä–æ—Å—å –º–æ–Ω–µ—Ç–∫—É",
    ],
    "blackjack": [
        "üí° /bj ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –±–ª—ç–∫–¥–∂–µ–∫",
        "üí° –í –±–ª—ç–∫–¥–∂–µ–∫–µ: hit, stand, double",
    ],
    "fish": [
        "üí° /fish ‚Äî —Ä—ã–±–∞–ª–∫–∞, –ø—Ä–æ–¥–∞–≤–∞–π —É–ª–æ–≤",
        "üí° –†–µ–¥–∫–∞—è —Ä—ã–±–∞ = –±–æ–ª—å—à–µ –º–æ–Ω–µ—Ç",
    ],
    "crash": [
        "üí° /crash 100 ‚Äî —É—Å–ø–µ–π –≤—ã–π—Ç–∏ –¥–æ –∫—Ä–∞—à–∞",
        "üí° –í crash —á–µ–º –¥–æ–ª—å—à–µ –∂–¥—ë—à—å, —Ç–µ–º –±–æ–ª—å—à–µ —Ä–∏—Å–∫",
    ],
    "roulette": [
        "üí° /roulette ‚Äî —Ä—É—Å—Å–∫–∞—è —Ä—É–ª–µ—Ç–∫–∞",
    ],
    "dice": [
        "üí° /dice 100 ‚Äî –∫–æ—Å—Ç–∏, —É–≥–∞–¥–∞–π —Å—É–º–º—É",
    ],
    "wheel": [
        "üí° /wheel ‚Äî –∫–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã",
    ],
    
    # === –°–û–¶–ò–ê–õ–ö–ê ===
    "guild": [
        "üí° /guilds ‚Äî —Å–ø–∏—Å–æ–∫ –≥–∏–ª—å–¥–∏–π",
        "üí° /create_guild –ù–∞–∑–≤–∞–Ω–∏–µ ‚Äî —Å–æ–∑–¥–∞–π —Å–≤–æ—é",
        "üí° /guild_info ‚Äî –∏–Ω—Ñ–æ –æ —Ç–≤–æ–µ–π –≥–∏–ª—å–¥–∏–∏",
    ],
    "duo": [
        "üí° /duo_invite @–¥—Ä—É–≥ ‚Äî —Å–æ–∑–¥–∞–π –¥—É—ç—Ç",
        "üí° /duo_profile ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥—É—ç—Ç–∞",
    ],
    "achievements": [
        "üí° /my_achievements ‚Äî —Ç–≤–æ–∏ –∞—á–∏–≤–∫–∏",
        "üí° –ï—Å—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è üëÄ",
    ],
    "quests": [
        "üí° /quests ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è",
        "üí° –ö–≤–µ—Å—Ç—ã –¥–∞—é—Ç –º–æ–Ω–µ—Ç—ã –∏ –æ–ø—ã—Ç",
    ],
    "profile": [
        "üí° /profile ‚Äî —Ç–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
        "üí° /profile @–Ω–∏–∫ ‚Äî —á—É–∂–æ–π –ø—Ä–æ—Ñ–∏–ª—å",
    ],
    
    # === –£–¢–ò–õ–ò–¢–´ ===
    "quote": [
        "üí° /q –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî —Ü–∏—Ç–∞—Ç–∞",
        "üí° /q 3 ‚Äî —Ü–µ–ø–æ—á–∫–∞ –∏–∑ 3 —Å–æ–æ–±—â–µ–Ω–∏–π",
        "üí° /q * ‚Äî –ø—Ä–æ–∂–∞—Ä–∫–∞ –æ—Ç –û–ª–µ–≥–∞",
    ],
    "voice": [
        "üí° /say —Ç–µ–∫—Å—Ç ‚Äî –û–ª–µ–≥ –æ–∑–≤—É—á–∏—Ç",
        "üí° –û—Ç–ø—Ä–∞–≤—å –≥–æ–ª–æ—Å–æ–≤–æ–µ ‚Äî –û–ª–µ–≥ –ø–æ–π–º—ë—Ç",
    ],
    "help": [
        "üí° /games ‚Äî –≤—Å–µ –∏–≥—Ä–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã",
        "üí° /help ‚Äî —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –±–æ—Ç—É",
        "üí° /limit ‚Äî —Ç–≤–æ–π –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤",
    ],
    "shop": [
        "üí° /shop ‚Äî –º–∞–≥–∞–∑–∏–Ω –ø—Ä–µ–¥–º–µ—Ç–æ–≤",
        "üí° /inventory ‚Äî —Ç–≤–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å",
    ],
    "tournament": [
        "üí° /tournament ‚Äî —Ç–µ–∫—É—â–∏–µ —Ç—É—Ä–Ω–∏—Ä—ã",
    ],
    
    # === –û–õ–ï–ì ===
    "oleg": [
        "üí° –°–ø—Ä–æ—Å–∏ –û–ª–µ–≥–∞ –ø—Ä–æ –∂–µ–ª–µ–∑–æ ‚Äî –æ–Ω —à–∞—Ä–∏—Ç",
        "üí° –°–∫–∏–Ω—å –∫–∞—Ä—Ç–∏–Ω–∫—É ‚Äî –û–ª–µ–≥ –ø—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ—Ç",
        "üí° –û–ª–µ–≥ –∑–Ω–∞–µ—Ç –ø—Ä–æ Linux, Steam Deck, —Ä–∞–∑–≥–æ–Ω",
    ],
}

# –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞
KEYWORDS = {
    "grow": ["—Ä–∞–∑–º–µ—Ä", "–º–∞–ª–µ–Ω—å–∫–∏–π", "–±–æ–ª—å—à–µ", "–≤—ã—Ä–∞—Å—Ç–∏", "—Ä–æ—Å—Ç", "—Å–º"],
    "pvp": ["–ø–≤–ø", "–¥—É—ç–ª—å", "–±–æ–π", "–¥—Ä–∞–∫–∞", "–≤—ã–∑–æ–≤", "—Å—Ä–∞–∑–∏—Ç—å—Å—è"],
    "top": ["—Ç–æ–ø", "–ª—É—á—à–∏–π", "—Ä–µ–π—Ç–∏–Ω–≥", "–ø–µ—Ä–≤—ã–π", "–ª–∏–¥–µ—Ä"],
    "casino": ["–∫–∞–∑–∏–Ω–æ", "—Å—Ç–∞–≤–∫–∞", "—É–¥–∞—á–∞", "–≤—ã–∏–≥—Ä–∞—Ç—å", "—Å–ª–æ—Ç—ã"],
    "blackjack": ["–±–ª—ç–∫–¥–∂–µ–∫", "–∫–∞—Ä—Ç—ã", "21", "bj"],
    "fish": ["—Ä—ã–±–∞", "—Ä—ã–±–∞–ª–∫–∞", "–ª–æ–≤–∏—Ç—å", "—É–¥–æ—á–∫–∞"],
    "crash": ["–∫—Ä–∞—à", "–º–Ω–æ–∂–∏—Ç–µ–ª—å"],
    "roulette": ["—Ä—É–ª–µ—Ç–∫–∞", "–ø–∞—Ç—Ä–æ–Ω"],
    "dice": ["–∫–æ—Å—Ç–∏", "–∫—É–±–∏–∫"],
    "wheel": ["–∫–æ–ª–µ—Å–æ", "—Ñ–æ—Ä—Ç—É–Ω–∞"],
    "guild": ["–≥–∏–ª—å–¥–∏—è", "–∫–ª–∞–Ω", "–∫–æ–º–∞–Ω–¥–∞"],
    "duo": ["–¥—É—ç—Ç", "–≤–¥–≤–æ–µ–º", "–ø–∞—Ä—Ç–Ω–µ—Ä", "–Ω–∞–ø–∞—Ä–Ω–∏–∫"],
    "achievements": ["–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è", "–∞—á–∏–≤–∫–∏", "–Ω–∞–≥—Ä–∞–¥—ã"],
    "quests": ["–∫–≤–µ—Å—Ç—ã", "–∑–∞–¥–∞–Ω–∏—è", "–º–∏—Å—Å–∏–∏"],
    "profile": ["–ø—Ä–æ—Ñ–∏–ª—å", "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "–º–æ–∏ –¥–∞–Ω–Ω—ã–µ"],
    "quote": ["—Ü–∏—Ç–∞—Ç–∞", "—Ü–∏—Ç–∞—Ç–Ω–∏–∫", "—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å"],
    "voice": ["–≥–æ–ª–æ—Å", "–æ–∑–≤—É—á–∏—Ç—å", "—Å–∫–∞–∑–∞—Ç—å"],
    "help": ["–ø–æ–º–æ—â—å", "–∫–æ–º–∞–Ω–¥—ã", "—á—Ç–æ —É–º–µ–µ—à—å", "—Ñ—É–Ω–∫—Ü–∏–∏"],
    "shop": ["–º–∞–≥–∞–∑–∏–Ω", "–∫—É–ø–∏—Ç—å", "–ø—Ä–µ–¥–º–µ—Ç—ã"],
    "tournament": ["—Ç—É—Ä–Ω–∏—Ä", "—Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ"],
    "oleg": ["–æ–ª–µ–≥", "–∂–µ–ª–µ–∑–æ", "–∫–æ–º–ø", "–≤–∏–¥–µ–æ–∫–∞—Ä—Ç–∞", "–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä", "linux"],
}


def _can_show_recommendation(user_id: int, category: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é."""
    now = time.time()
    last_time = _last_recommendation_time.get(user_id, 0)
    last_type = _last_recommendation_type.get(user_id)
    
    if now - last_time < RECOMMENDATION_COOLDOWN:
        return False
    
    # –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—É –∂–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ–¥—Ä—è–¥
    if last_type == category:
        return False
    
    return True


def _record_recommendation(user_id: int, category: str):
    """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ñ–∞–∫—Ç –ø–æ–∫–∞–∑–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏."""
    _last_recommendation_time[user_id] = time.time()
    _last_recommendation_type[user_id] = category


def get_random_tip() -> str:
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é (–¥–ª—è –¥–µ–π–ª–∏–∫–æ–≤ –∏ —Ç.–ø.)."""
    category = random.choice(list(RECOMMENDATIONS.keys()))
    return random.choice(RECOMMENDATIONS[category])


async def generate_recommendation(
    session: AsyncSession, user: User, user_text: str
) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å —à–∞–Ω—Å–æ–º 12%, –Ω–µ —á–∞—â–µ —Ä–∞–∑–∞ –≤ 5 –º–∏–Ω—É—Ç.
    """
    if random.random() > RECOMMENDATION_CHANCE:
        return ""
    
    text_lower = user_text.lower()
    matched_categories = []
    
    for category, keywords in KEYWORDS.items():
        for keyword in keywords:
            if keyword in text_lower:
                matched_categories.append(category)
                break
    
    if not matched_categories:
        return ""
    
    available = [
        cat for cat in matched_categories 
        if _can_show_recommendation(user.id, cat)
    ]
    
    if not available:
        return ""
    
    category = random.choice(available)
    recommendation = random.choice(RECOMMENDATIONS[category])
    
    _record_recommendation(user.id, category)
    
    return recommendation
