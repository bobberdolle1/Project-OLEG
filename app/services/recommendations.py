"""–°–∏—Å—Ç–µ–º–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""

import random
import time
from collections import defaultdict
from sqlalchemy.ext.asyncio import AsyncSession
from app.database.models import User

# –ö—É–ª–¥–∞—É–Ω —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
RECOMMENDATION_COOLDOWN = 300  # 5 –º–∏–Ω—É—Ç
# –®–∞–Ω—Å –ø–æ–∫–∞–∑–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–¥–∞–∂–µ –µ—Å–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ)
RECOMMENDATION_CHANCE = 0.15  # 15%

# –¢—Ä–µ–∫–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
_last_recommendation_time: dict[int, float] = defaultdict(float)
_last_recommendation_type: dict[int, str] = {}


# –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
RECOMMENDATIONS = {
    "grow": [
        "–•–æ—á–µ—à—å —Å—Ç–∞—Ç—å –±–æ–ª—å—à–µ? –ü–æ–ø—Ä–æ–±—É–π `/grow`!",
        "–†–∞–∑–º–µ—Ä –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ! –ñ–º–∏ `/grow`",
        "–ú–∞–ª–æ–≤–∞—Ç? `/grow` –ø–æ–º–æ–∂–µ—Ç!",
        "–í—Ä–µ–º—è —Ä–∞—Å—Ç–∏! `/grow` —Ä–∞–∑ –≤ 12 —á–∞—Å–æ–≤",
        "–ö–∞—á–∞–π —Ä–∞–∑–º–µ—Ä: `/grow`",
        "–ù–µ —Å—Ç–æ–π –Ω–∞ –º–µ—Å—Ç–µ ‚Äî `/grow`!",
        "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å `/grow` ‚Äî –ø—É—Ç—å –∫ —Ç–æ–ø—É",
        "–•–æ—á–µ—à—å –≤ —Ç–æ–ø? –ù–∞—á–Ω–∏ —Å `/grow`",
    ],
    "pvp": [
        "–ì–æ—Ç–æ–≤ –∫ –±–æ—é? –í—ã–∑–æ–≤–∏ –∫–æ–≥–æ-–Ω–∏–±—É–¥—å –Ω–∞ `/challenge`!",
        "–•–æ—á–µ—à—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–ª—É? `/challenge @–Ω–∏–∫` ‚Äî –∏ –≤–ø–µ—Ä—ë–¥!",
        "–î—É—ç–ª—å? `/challenge` –∂–¥—ë—Ç —Ç–µ–±—è!",
        "–î–æ–∫–∞–∂–∏ –∫—Ç–æ —Ç—É—Ç –≥–ª–∞–≤–Ω—ã–π: `/challenge`",
        "–û—Ç–≤–µ—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –Ω–∞–ø–∏—à–∏ `/challenge`",
        "PvP —Å –û–ª–µ–≥–æ–º: –ø—Ä–æ—Å—Ç–æ `/challenge`",
        "–ó–æ–Ω–Ω—ã–π –±–æ–π: –∞—Ç–∞–∫–∞ + –∑–∞—â–∏—Ç–∞. `/challenge`",
    ],
    "top": [
        "–•–æ—á–µ—à—å –±—ã—Ç—å –ª—É—á—à–∏–º? –ü—Ä–æ–≤–µ—Ä—å `/top`!",
        "–ì–ª—è–Ω—å `/top_rep` ‚Äî –º–æ–∂–µ—Ç —Ç—ã —É–∂–µ –≤ —Ç–æ–ø–µ?",
        "–†–µ–π—Ç–∏–Ω–≥ –∂–¥—ë—Ç: `/top` –∏–ª–∏ `/top_rep`",
        "–ö—Ç–æ —Å–∞–º—ã–π –±–æ–ª—å—à–æ–π? `/top`",
        "–¢–æ–ø –ø–æ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏: `/top_rep`",
        "–ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ—é –ø–æ–∑–∏—Ü–∏—é: `/top`",
    ],
    "achievements": [
        "–ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–∏ `/my_achievements`!",
        "–ê—á–∏–≤–∫–∏ –∂–¥—É—Ç! `/my_achievements`",
        "–ó–∞–≥–ª—è–Ω–∏ –≤ `/achievements_leaderboard`!",
        "–°–æ–±–µ—Ä–∏ –≤—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è!",
        "–°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∞—á–∏–≤–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç üëÄ",
    ],
    "quests": [
        "–ù–µ –∑–Ω–∞–µ—à—å, —á—Ç–æ –¥–µ–ª–∞—Ç—å? –ó–∞–≥–ª—è–Ω–∏ –≤ `/quests`!",
        "–ö–≤–µ—Å—Ç—ã –¥–∞—é—Ç –Ω–∞–≥—Ä–∞–¥—ã! `/quests`",
        "–ü—Ä–æ–≤–µ—Ä—å –∑–∞–¥–∞–Ω–∏—è: `/quests`",
        "–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∫–≤–µ—Å—Ç—ã –æ–±–Ω–æ–≤–∏–ª–∏—Å—å!",
    ],
    "guild": [
        "–ò—â–µ—à—å –∫–æ–º–∞–Ω–¥—É? `/create_guild` –∏–ª–∏ `/join_guild`!",
        "–ì–∏–ª—å–¥–∏—è ‚Äî —Å–∏–ª–∞! `/guild_info`",
        "–°–æ–∑–¥–∞–π —Å–≤–æ—é –≥–∏–ª—å–¥–∏—é: `/create_guild`",
        "–í–º–µ—Å—Ç–µ –≤–µ—Å–µ–ª–µ–µ! `/guilds`",
    ],
    "duo": [
        "–•–æ—á–µ—à—å –∏–≥—Ä–∞—Ç—å –≤–¥–≤–æ–µ–º? `/duo_invite @–¥—Ä—É–≥`",
        "–î—É—ç—Ç —Å–∏–ª—å–Ω–µ–µ! `/duo_invite`",
        "–ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–π –¥—É—ç—Ç: `/duo_profile`",
        "–ù–∞–π–¥–∏ –Ω–∞–ø–∞—Ä–Ω–∏–∫–∞ –¥–ª—è –¥—É—ç—Ç–∞!",
    ],
    "casino": [
        "–ß—É–≤—Å—Ç–≤—É–µ—à—å —É–¥–∞—á—É? `/casino` –∂–¥—ë—Ç!",
        "–†–∏—Å–∫–Ω–∏ –≤ `/casino`! –ù–æ –Ω–µ –≤—Å—ë —Å—Ä–∞–∑—É",
        "–°–ª–æ—Ç—ã –∫—Ä—É—Ç—è—Ç—Å—è: `/casino [—Å—Ç–∞–≤–∫–∞]`",
        "–î–∂–µ–∫–ø–æ—Ç x5! `/casino`",
        "–ü–æ–ø—Ä–æ–±—É–π `/roulette` ‚Äî —Ä—É—Å—Å–∫–∞—è —Ä—É–ª–µ—Ç–∫–∞",
        "–ú–æ–Ω–µ—Ç–∫–∞: `/coinflip [—Å—Ç–∞–≤–∫–∞] –æ—Ä—ë–ª`",
    ],
    "games": [
        "–í—Å–µ –∏–≥—Ä—ã —Ç—É—Ç: `/games`",
        "–ù–µ –∑–Ω–∞–µ—à—å —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å? `/games`",
        "–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥: `/games`",
        "–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏–≥—Ä–∞–º: `/games`",
    ],
    "profile": [
        "–ì–ª—è–Ω—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å: `/profile`",
        "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∂–¥—ë—Ç: `/profile`",
        "–¢–≤–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤ `/profile`",
        "–ü—Ä–æ–≤–µ—Ä—å —Å–≤–æ–π —Ä–∞–Ω–≥: `/profile`",
    ],
    "blackjack": [
        "–õ—é–±–∏—à—å –∫–∞—Ä—Ç—ã? `/bj`!",
        "21 –æ—á–∫–æ: `/bj [—Å—Ç–∞–≤–∫–∞]`",
        "–ë–ª—ç–∫–¥–∂–µ–∫ –ø—Ä–æ—Ç–∏–≤ –¥–∏–ª–µ—Ä–∞: `/bj`",
        "–•–∏—Ç –∏–ª–∏ —Å—Ç–æ–ø? `/bj`",
    ],
    "fish": [
        "–ü–æ—Ä—ã–±–∞—á—å: `/fish`!",
        "–†—ã–±–∞–ª–∫–∞ —Ä–∞—Å—Å–ª–∞–±–ª—è–µ—Ç: `/fish`",
        "–õ–æ–≤–∏ —Ä—ã–±—É, –ø—Ä–æ–¥–∞–≤–∞–π –∑–∞ –º–æ–Ω–µ—Ç—ã: `/fish`",
        "–†–µ–¥–∫–∞—è —Ä—ã–±–∞ = –±–æ–ª—å—à–µ –º–æ–Ω–µ—Ç!",
    ],
    "crash": [
        "–ò—Å–ø—ã—Ç–∞–π —É–¥–∞—á—É –≤ `/crash`!",
        "–£—Å–ø–µ–π –≤—ã–π—Ç–∏ –≤–æ–≤—Ä–µ–º—è: `/crash`",
        "–ú–Ω–æ–∂–∏—Ç–µ–ª—å —Ä–∞—Å—Ç—ë—Ç... `/crash`",
    ],
    "roulette": [
        "–†—É—Å—Å–∫–∞—è —Ä—É–ª–µ—Ç–∫–∞: `/roulette`",
        "–û–¥–∏–Ω –ø–∞—Ç—Ä–æ–Ω, —à–µ—Å—Ç—å –∫–∞–º–µ—Ä: `/roulette`",
        "–†–∏—Å–∫–Ω–∏ –≤—Å–µ–º: `/roulette [—Å—Ç–∞–≤–∫–∞]`",
    ],
    "tournament": [
        "–¢—É—Ä–Ω–∏—Ä—ã –∏–¥—É—Ç! `/tournament`",
        "–ü—Ä–æ–≤–µ—Ä—å —Ç—É—Ä–Ω–∏—Ä–Ω—É—é —Ç–∞–±–ª–∏—Ü—É: `/tournament`",
    ],
}

# –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
KEYWORDS = {
    "grow": ["—Ä–∞–∑–º–µ—Ä", "–º–∞–ª–µ–Ω—å–∫–∏–π", "–±–æ–ª—å—à–µ", "–≤—ã—Ä–∞—Å—Ç–∏", "—Ä–æ—Å—Ç", "—Å–º", "—Å–∞–Ω—Ç–∏–º–µ—Ç—Ä"],
    "pvp": ["–ø–≤–ø", "–¥—É—ç–ª—å", "—Å—Ä–∞–∑–∏—Ç—å—Å—è", "–±–æ–π", "–¥—Ä–∞–∫–∞", "–ø–æ–±–∏—Ç—å", "–≤—ã–∑–æ–≤", "challenge"],
    "top": ["—Ç–æ–ø", "–ª—É—á—à–∏–π", "—Ä–µ–π—Ç–∏–Ω–≥", "–ø–µ—Ä–≤—ã–π", "–ª–∏–¥–µ—Ä", "–º–µ—Å—Ç–æ"],
    "achievements": ["–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è", "–∞—á–∏–≤–∫–∏", "–Ω–∞–≥—Ä–∞–¥—ã", "–º–µ–¥–∞–ª–∏", "achievement"],
    "quests": ["–∫–≤–µ—Å—Ç—ã", "–∑–∞–¥–∞–Ω–∏—è", "–º–∏—Å—Å–∏–∏", "—á—Ç–æ –¥–µ–ª–∞—Ç—å", "quest"],
    "guild": ["–≥–∏–ª—å–¥–∏—è", "–∫–ª–∞–Ω", "–∫–æ–º–∞–Ω–¥–∞", "–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ", "guild"],
    "duo": ["–¥—É—ç—Ç", "–≤–¥–≤–æ–µ–º", "–ø–∞—Ä—Ç–Ω–µ—Ä", "–Ω–∞–ø–∞—Ä–Ω–∏–∫", "–¥—Ä—É–≥", "duo"],
    "casino": ["–∫–∞–∑–∏–Ω–æ", "—Å—Ç–∞–≤–∫–∞", "—É–¥–∞—á–∞", "–≤—ã–∏–≥—Ä–∞—Ç—å", "—Å–ª–æ—Ç—ã", "casino"],
    "games": ["–∏–≥—Ä—ã", "–∫–æ–º–∞–Ω–¥—ã", "—á—Ç–æ –µ—Å—Ç—å", "—Ñ—É–Ω–∫—Ü–∏–∏", "–ø–æ–º–æ—â—å", "help"],
    "profile": ["–ø—Ä–æ—Ñ–∏–ª—å", "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "–º–æ–∏ –¥–∞–Ω–Ω—ã–µ", "profile"],
    "blackjack": ["–±–ª—ç–∫–¥–∂–µ–∫", "–∫–∞—Ä—Ç—ã", "21", "blackjack", "bj"],
    "fish": ["—Ä—ã–±–∞", "—Ä—ã–±–∞–ª–∫–∞", "–ª–æ–≤–∏—Ç—å", "fish", "—É–¥–æ—á–∫–∞"],
    "crash": ["–∫—Ä–∞—à", "–º–Ω–æ–∂–∏—Ç–µ–ª—å", "crash"],
    "roulette": ["—Ä—É–ª–µ—Ç–∫–∞", "roulette", "–ø–∞—Ç—Ä–æ–Ω"],
    "tournament": ["—Ç—É—Ä–Ω–∏—Ä", "tournament", "—Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ"],
}


def _can_show_recommendation(user_id: int, category: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."""
    now = time.time()
    last_time = _last_recommendation_time.get(user_id, 0)
    last_type = _last_recommendation_type.get(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—É–ª–¥–∞—É–Ω
    if now - last_time < RECOMMENDATION_COOLDOWN:
        return False
    
    # –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç—É –∂–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ–¥—Ä—è–¥
    if last_type == category:
        return False
    
    return True


def _record_recommendation(user_id: int, category: str):
    """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ñ–∞–∫—Ç –ø–æ–∫–∞–∑–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏."""
    _last_recommendation_time[user_id] = time.time()
    _last_recommendation_type[user_id] = category


async def generate_recommendation(
    session: AsyncSession, user: User, user_text: str
) -> str:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–≥—Ä–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É.
    
    –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è:
    - –° —à–∞–Ω—Å–æ–º 15%
    - –ù–µ —á–∞—â–µ —Ä–∞–∑–∞ –≤ 5 –º–∏–Ω—É—Ç –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    - –ù–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç –ø—Ä–µ–¥—ã–¥—É—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —à–∞–Ω—Å –ø–æ–∫–∞–∑–∞
    if random.random() > RECOMMENDATION_CHANCE:
        return ""
    
    text_lower = user_text.lower()
    matched_categories = []
    
    # –ò—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    for category, keywords in KEYWORDS.items():
        for keyword in keywords:
            if keyword in text_lower:
                matched_categories.append(category)
                break
    
    if not matched_categories:
        return ""
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ –∫—É–ª–¥–∞—É–Ω—É
    available_categories = [
        cat for cat in matched_categories 
        if _can_show_recommendation(user.id, cat)
    ]
    
    if not available_categories:
        return ""
    
    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é
    category = random.choice(available_categories)
    recommendation = random.choice(RECOMMENDATIONS[category])
    
    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–∫–∞–∑
    _record_recommendation(user.id, category)
    
    return recommendation
