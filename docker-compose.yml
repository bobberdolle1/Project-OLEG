version: '3.8'

services:
  # Основной сервис бота
  oleg-bot:
    build: .
    container_name: oleg-bot
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_FILE=/app/logs/oleg.log
    volumes:
      # Сохранение базы данных между перезагрузками
      - oleg-data:/app/data
      # Сохранение логов
      - oleg-logs:/app/logs
      # Данные векторной базы
      - chroma-data:/app/chroma_data
    networks:
      - oleg-network
    depends_on:
      - chromadb
      - redis
    healthcheck:
      test: ["CMD", "python", "-c", "import logging; print('alive')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ChromaDB - векторная база данных для RAG (Мозг Олега)
  chromadb:
    image: ghcr.io/chroma-core/chroma:latest
    container_name: chromadb-server
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - chroma-data:/chroma/chroma
    environment:
      - CHROMA_DB_IMPL=clickhouse
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=9000
    networks:
      - oleg-network
    depends_on:
      - clickhouse
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ClickHouse - для обеспечения хранения в ChromaDB
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse-server
    restart: unless-stopped
    volumes:
      - clickhouse-data:/var/lib/clickhouse
    ports:
      - "9000:9000"
      - "8123:8123"
    networks:
      - oleg-network
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # Redis для кэширования и rate limiting
  redis:
    image: redis:7-alpine
    container_name: oleg-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - oleg-network
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # PostgreSQL для продакшена (закомментирован по умолчанию)
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: oleg-postgres
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_DB: oleg_db
  #     POSTGRES_USER: oleg
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   ports:
  #     - "5432:5432"
  #   networks:
  #     - oleg-network
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U oleg"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "5m"
  #       max-file: "2"

volumes:
  oleg-data:
    driver: local
  oleg-logs:
    driver: local
  chroma-data:
    driver: local
  clickhouse-data:
    driver: local
  redis-data:
    driver: local
  # postgres-data:
  #   driver: local

networks:
  oleg-network:
    driver: bridge
