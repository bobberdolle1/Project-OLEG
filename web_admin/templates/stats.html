{% extends "base.html" %}

{% block header %}Статистика чата{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3 mb-4">
        <div class="card stat-card">
            <div class="card-body">
                <div class="number">{{ user_count }}</div>
                <div class="label">Всего пользователей</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card stat-card">
            <div class="card-body">
                <div class="number">{{ message_count }}</div>
                <div class="label">Сообщений за 24ч</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card stat-card">
            <div class="card-body">
                <div class="number">42</div>
                <div class="label">Активных сегодня</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-4">
        <div class="card stat-card">
            <div class="card-body">
                <div class="number">12</div>
                <div class="label">Новых за 24ч</div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-chart-bar"></i> Активность пользователей (топ-10)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped mb-0">
                        <thead>
                            <tr>
                                <th>№</th>
                                <th>Пользователь</th>
                                <th>Сообщений</th>
                                <th>% от общего</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for username, count in active_users %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    {% if username %}
                                        @{{ username }}
                                    {% else %}
                                        Аноним
                                    {% endif %}
                                </td>
                                <td>{{ count }}</td>
                                <td>
                                    {% if message_count > 0 %}
                                        {{ "%.2f"|format((count / message_count * 100)) }}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center">Нет данных</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-chart-pie"></i> Статистика по часам</h5>
            </div>
            <div class="card-body">
                <canvas id="hourlyChart" height="200"></canvas>
                <div class="mt-3 small text-center text-muted">
                    <div class="row">
                        <div class="col">Утро</div>
                        <div class="col">День</div>
                        <div class="col">Вечер</div>
                        <div class="col">Ночь</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="fas fa-comments"></i> Типы сообщений</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-around">
                    <div class="text-center">
                        <div class="h5 text-primary">85%</div>
                        <div class="small text-muted">Текст</div>
                    </div>
                    <div class="text-center">
                        <div class="h5 text-success">8%</div>
                        <div class="small text-muted">Фото</div>
                    </div>
                    <div class="text-center">
                        <div class="h5 text-info">5%</div>
                        <div class="small text-muted">Стикер</div>
                    </div>
                    <div class="text-center">
                        <div class="h5 text-warning">2%</div>
                        <div class="small text-muted">Другое</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <h5 class="card-title mb-0"><i class="fas fa-chart-line"></i> Активность за последнюю неделю</h5>
    </div>
    <div class="card-body">
        <canvas id="weeklyChart" height="80"></canvas>
    </div>
</div>

<script>
// Простые графики для демонстрации
document.addEventListener('DOMContentLoaded', function() {
    // Часовой график (заглушка)
    const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
    new Chart(hourlyCtx, {
        type: 'bar',
        data: {
            labels: ['6-12', '12-18', '18-24', '0-6'],
            datasets: [{
                label: 'Сообщения',
                data: [35, 42, 38, 15],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(54, 162, 235, 0.6)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Недельный график (заглушка)
    const weeklyCtx = document.getElementById('weeklyChart');
    if (weeklyCtx) {
        new Chart(weeklyCtx, {
            type: 'line',
            data: {
                labels: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
                datasets: [{
                    label: 'Сообщения',
                    data: [125, 142, 135, 168, 195, 210, 180],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}